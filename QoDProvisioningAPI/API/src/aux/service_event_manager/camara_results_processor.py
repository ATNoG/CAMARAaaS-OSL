import asyncio

from aux.service_event_manager.service_event_manager import ServiceEventManager
from config import Config
import json
from database import crud
from database.db import get_db

# Set up logging
logger = Config.setup_logging()

class CamaraResultsProcessor:
    """Handles processing of camara results from the queue."""
    
    results = [{"device": {"ipv4Address": {"privateAddress": "192.168.1.100", "publicAddress": "203.0.113.0", "publicPort": 5000}, "ipv6Address": "2001:db8::ff00:42:8329", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "3fa85f64-5717-4562-b3fc-2c963f66afa7", "qosProfile": "QOS_A", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "AVAILABLE", "startedAt": "2024-12-13T09:52:30Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "0b2a2189-c572-423f-850b-524a57f02933", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:14:02Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "3c9e6e3e-6e02-4e36-9c72-a9c2013b77fe", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:33:02Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "04dfed40-2780-4cfe-a8dc-2963d7045df9", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:33:51Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "5f63a8c9-3454-4d48-91e1-af2a54e136d8", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:38:41Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "c098a1e2-1f62-4072-909a-c1fa56236319", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:42:02Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "7e702d7b-d723-403e-ba5e-58b4ef92684d", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:43:11Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456788"}, "provisioningId": "4ab858f7-c25c-4431-8d4c-e24990e9d41d", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:43:41Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "a82c15e2-bc8f-49ea-9ba6-3263831e108b", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:49:41Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "de33c9a9-1f6a-4fae-adff-6fd728db5129", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:51:02Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "eb154ab5-787c-4adc-813d-fa96e451cac2", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:51:32Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "13c9522e-1939-46bd-96c2-e6ec63139ce8", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:52:32Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "ce30671a-b1d6-41df-aef1-2fdda76bb1f8", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:54:41Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "93734067-ec0b-486f-9b9e-ad29873259d3", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:55:21Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "a266b3ac-c322-4f46-b84d-ecdf28c67605", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T11:58:41Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "346c6cad-ede5-4ab5-b5e7-2e1eebdcfef7", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:04:41Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "565b7850-7cc1-4cc4-9cda-77e1dee44d4f", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:05:32Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "edfe9a48-a4c2-413c-9af2-222ad16f0b3c", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:06:41Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "308d480a-4563-461c-83db-ff4c8933b377", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:07:11Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "e3955ba0-79d6-4ff6-9513-dc4bbe72d882", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:08:02Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "2b24832b-3a34-41c7-ab4c-e66876d425f5", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:09:32Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "4b2e2fde-b68f-4e80-a26c-38a206d6da20", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:10:11Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "3d7de1df-570c-4b9f-8c5a-7c65241fc63d", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:15:11Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "7b959c5c-97b3-4306-9128-24209a8b39e2", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:15:51Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "731cdf84-eec9-4ef4-8a2b-1a23d41e602b", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:16:32Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "86122dc4-e7a5-4a61-a598-8dac11ee900d", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:18:21Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "4900121f-0d38-4412-8900-c9ff6854e875", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:18:52Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "576d9799-f1ec-441f-877e-9e823ebc6448", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:20:21Z"}, {"device": {"ipv4Address": {"privateAddress": "172.16.1.1", "publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "2c202932-a028-444f-b923-530e99f11f51", "qosProfile": "QCI_1_voice", "sink": "https://endpoint.example.com/sink", "sinkCredential": {"credentialType": "PLAIN"}, "status": "UNAVAILABLE", "startedAt": "2024-12-13T12:21:33Z"}, {"device": {"ipv4Address": {"publicAddress": "203.0.113.0", "publicPort": 59765}, "ipv6Address": "2001:db8:85a3:8d3:1319:8a2e:370:7344", "networkAccessIdentifier": "123456789@domain.com", "phoneNumber": "+123456789"}, "provisioningId": "306819d7-6532-457a-be8f-592bc32c24af", "qosProfile": "QOS_B", "sink": "https://endpoint.example.com/sink", "sinkCredential": {}, "status": "AVAILABLE", "startedAt": "2024-12-13T14:00:42Z"}]

    def __init__(self, queue):
        self.queue = queue
        self.db_session = next(get_db())

    async def process_results(self):
        """Continuously processes results from the queue."""
        try:
            results = None
            # Enter the infinite loop to process subsequent results
            while True:
                results_str = await self.queue.get()
                try:
                    results = json.loads(results_str)
                except Exception as e:
                    logger.error(
                        f"Could not parse Camara results. Reason: {e}"
                    )
                logger.info(f"Amounf of processed CAMARA Results: {len(results)}.")
                logger.debug(f"Processed camaraResults: {results}")
                self.update_provisionings(results)
                self.remove_deleted_provisionings(results)
        except asyncio.CancelledError:
            logger.info("CamaraResultsProcessor stopped gracefully.")
        except Exception as e:
            logger.error(f"Error processing camara results: {e}", exc_info=True)

    def update_provisionings(self, current_results):
        
        for result in current_results:
            try:
                prov_id = result["provisioningId"]
                prov_status = result["status"]
                prov_timestamp =  result["startedAt"]
                crud.update_provisioning_by_id(
                    self.db_session,
                    prov_id,
                    prov_status,
                    prov_timestamp
                    
                )
            except Exception as e:
                logger.error(
                    f"Could not process CAMARA Result: {result}. Reason: {e}"
                )
        # 1. identificar quais os campos atualizados
        # - status
        # started at
        # status info
        
        # Filtro por caracteristica e operation e provisioning ID
        pass
    
    def remove_deleted_provisionings(self, current_results):
         pass